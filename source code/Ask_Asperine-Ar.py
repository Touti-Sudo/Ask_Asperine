from flask import Flask, send_from_directory, request, jsonify, render_template
import matplotlib.pyplot as plt
import numpy as np
import matplotlib
matplotlib.use('Agg')  
import matplotlib.animation as animation
import os
import threading 
import tkinter as tk
from PIL import Image, ImageTk
import time
import webbrowser

# ุชุฃูุฏ ูู ูุฌูุฏ ูุฌูุฏ "static"
if not os.path.exists("static"):
    os.makedirs("static")

app = Flask(__name__)

# ุจูุงูุงุช ุงูุฃุณุจุฑูู
aspirin_data = {
    "histoire": {
        "description": "๐ ุชู ุชุตููุน ุงูุฃุณุจุฑูู ูู ุนุงู 1897 ูู ูุจู ๐งโ๐ฌ ูููููุณ ููููุงู ูู ุดุฑูุฉ ุจุงูุฑ. ูุจู ุฐููุ ูุงู ูุชู ุงุณุชุฎุฏุงู ๐ฟ ุงูุณุงููุณููุ ุงููุณุชุฎุฑุฌ ูู ุดุฌุฑุฉ ุงูุตูุตุงูุ ููุฐ ุงูุนุตูุฑ ุงููุฏููุฉ ูุนูุงุฌ ุงูุฃูู ูุงูุญูู.",
        "dates_importantes": [
            "๐บ ุงูุนุตูุฑ ุงููุฏููุฉ: ุงุณุชุฎุฏุงู ูุญุงุก ุงูุตูุตุงู ูุนูุงุฌ ุงูุฃูู ูุงูุญูู.",
            "๐งช 1828: ูููุงู ุจูุดูุฑ ูุนุฒู ุงูุณุงููุณูู.",
            "โ๏ธ 1853: ุชุดุงุฑูุฒ ูุฑูุฏุฑูู ุฌูุฑูุงุฑุฏ ูููู ุจุฃูู ุชุตููุน ูุญูุถ ุงูุฃุณูุชูู ุณุงููุณูููู.",
            "๐ 1897: ูููููุณ ููููุงู ูุตูุน ุงูุฃุณุจุฑูู ุงูุญุฏูุซ ูู ุดุฑูุฉ ุจุงูุฑ."
        ]
    },
    "decouverte": {
        "description": "๐ฌ ูุนูุฏ ุงูุงุณุชุฎุฏุงู ุงูุทุจู ูุญุงุก ุงูุตูุตุงู ุฅูู ุงูุนุตูุฑ ุงููุฏููุฉ. ูู ุนุงู 1828ุ ุนุฒู ูููุงู ุจูุดูุฑ ุงูุณุงููุณููุ ููู ุนุงู 1897ุ ูุงู ูููููุณ ููููุงู ุจุชุตููุน ุญูุถ ุงูุฃุณูุชูู ุณุงููุณููููุ ููุง ุฃุฏู ุฅูู ุฅูุดุงุก ุงูุฃุณุจุฑูู ุงูุญุฏูุซ.",
        "personnages_cles": [
            "๐ฟ ุฃุจูุฑุงุท: ูุงู ูุณุชุฎุฏู ูุญุงุก ุงูุตูุตุงู ูุชุฎููู ุงูุฃูู.",
            "๐งช ูููุงู ุจูุดูุฑ: ูุงู ุจุนุฒู ุงูุณุงููุณูู ูู ุนุงู 1828.",
            "โ๏ธ ุชุดุงุฑูุฒ ูุฑูุฏุฑูู ุฌูุฑูุงุฑุฏ: ูุงู ุจุฃูู ุชุตููุน ูุญูุถ ุงูุฃุณูุชูู ุณุงููุณูููู ูู ุนุงู 1853.",
            "๐ ูููููุณ ููููุงู: ูุงู ุจุชุตููุน ุงูุฃุณุจุฑูู ูู ุนุงู 1897."
        ]
    },
    "preparation": {
        "reactifs": ["๐งช ุญูุถ ุงูุณุงููุณูููู", "โ๏ธ ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู", "๐๏ธ ุญูุถ ุงููุจุฑูุชูู (ุนุงูู ูุณุงุนุฏ)"],
        "reaction": "โ๏ธ ุญูุถ ุงูุณุงููุณูููู + ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู โ ๐ ุญูุถ ุงูุฃุณูุชูู ุณุงููุณูููู (ุฃุณุจุฑูู) + ๐งด ุญูุถ ุงูุฃุณูุชูู",
        "etapes": [
            "1๏ธโฃ ุงุฎูุท ุญูุถ ุงูุณุงููุณูููู ูุน ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู.",
            "2๏ธโฃ ุฃุถู ุจุถุน ูุทุฑุงุช ูู ุญูุถ ุงููุจุฑูุชูู.",
            "3๏ธโฃ ุณุฎู ุงูุฎููุท ุฅูู ๐ฅ 50-60ยฐC ููุฏุฉ 15 ุฏูููุฉ.",
            "4๏ธโฃ ุจุฑุฏ ุงูุฎููุท ูุฃุถู ุงููุงุก ุงูุจุงุฑุฏ ูุชุฑุณูุจ ุงูุฃุณุจุฑูู.",
            "5๏ธโฃ ูู ุจุชุฑุดูุญ ุงูุจููุฑุงุช ูุฌูููุง."
        ]
    },
    "synthese_chimique": {
        "reactifs": ["๐งช ุญูุถ ุงูุณุงููุณูููู", "โ๏ธ ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู", "๐๏ธ ุญูุถ ุงููุจุฑูุชูู (ุนุงูู ูุณุงุนุฏ)"],
        "reactions": "C7H6O3 + C4H6O3 โ C9H8O4 + C2H4O2",
        "reaction": "โ๏ธ ุญูุถ ุงูุณุงููุณูููู + ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู โ ๐ ุญูุถ ุงูุฃุณูุชูู ุณุงููุณูููู (ุฃุณุจุฑูู) + ๐งด ุญูุถ ุงูุฃุณูุชูู",
        "etapes": [
            "1๏ธโฃ ุงุฎูุท ุญูุถ ุงูุณุงููุณูููู ูุน ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู.",
            "2๏ธโฃ ุฃุถู ุจุถุน ูุทุฑุงุช ูู ุญูุถ ุงููุจุฑูุชูู.",
            "3๏ธโฃ ุณุฎู ุงูุฎููุท ุฅูู ๐ฅ 50-60ยฐC ููุฏุฉ 15 ุฏูููุฉ.",
            "4๏ธโฃ ุจุฑุฏ ุงูุฎููุท ูุฃุถู ุงููุงุก ุงูุจุงุฑุฏ ูุชุฑุณูุจ ุงูุฃุณุจุฑูู.",
            "5๏ธโฃ ูู ุจุชุฑุดูุญ ุงูุจููุฑุงุช ูุฌูููุง."
        ]
    },
    "utilisations_anciennes": [
        "๐บ ุงูุนุตูุฑ ุงููุฏููุฉ: ุดุงู ูุญุงุก ุงูุตูุตุงู ูุนูุงุฌ ๐ก๏ธ ุงูุญูู ู ๐ค ุงูุฃูู.",
        "๐ 400 ู.ู: ๐๏ธ ุฃุจูุฑุงุท ูุณุชุฎุฏูู ูุนูุงุฌ ุขูุงู ุงูููุงุตู.",
        "โณ ุงูุนุตูุฑ ุงููุณุทู: ูุงู ูุณุชุฎุฏูู ุงููุนุงูุฌูู ูุงูุฃุนุดุงุจููู.",
        "๐งช ุงููุฑู ุงูุซุงูู ุนุดุฑ: ุฅุฏูุงุฑุฏ ุณุชูู ููุชุดู ุขุซุงุฑู ูููุงุฑูู ุจุงูููููู."
    ],
    "utilisations_modernes": [
        "๐ ูุณูู ููุฃูู: ูุนุงูุฌ ุงูุตุฏุงุน ูุขูุงู ุงูุนุถูุงุช.",
        "๐ฅ ูุถุงุฏ ููุงูุชูุงุจุงุช: ุนูุงุฌ ุงูุฑููุงุชูุฒู ูุงูุชูุงุจ ุงูููุงุตู.",
        "๐ก๏ธ ุฎุงูุถ ููุญุฑุงุฑุฉ: ูููู ุงูุญูู.",
        "โค๏ธ ูุถุงุฏ ููุชุฎุซุฑ: ุงูููุงูุฉ ูู ุงูุณูุชุงุช ุงูุฏูุงุบูุฉ ูุงูููุจุงุช ุงูููุจูุฉ."
    ],
    "effets_secondaires": [
        "โ๏ธ ุชููุฌ ุงููุนุฏุฉ ููุฑุญุฉ ุงููุนุฏุฉ.",
        "๐ฉธ ุงุถุทุฑุงุจุงุช ุงููุฒูู (ุชุณููู ุงูุฏู).",
        "๐คง ุฑุฏูุฏ ูุนู ุชุญุณุณูุฉ ูุญุชููุฉ.",
        "๐ซ ูุง ุชุฃุฎุฐู ูู ุญุงูุฉ ุญุณุงุณูุฉ ูู ุงูุฃุณุจุฑูู ุฃู ุงุถุทุฑุงุจุงุช ุชุฎุซุฑ ุงูุฏู."
    ],
    "generalites": {
        "description": "๐ ุงูุฃุณุจุฑููุ ุฃู ุญูุถ ุงูุฃุณูุชูู ุณุงููุณููููุ ูู ุฏูุงุก ูุถุงุฏ ููุงูุชูุงุจุงุช ุบูุฑ ุณุชูุฑููุฏู (AINS) ๐ฆ ูุณุงุนุฏ ูู ุชุฎููู ุงูุฃูู ๐ุ ุฎูุถ ุงูุญูู ๐ก๏ธุ ูุชูููู ุงูุงูุชูุงุจ ๐ฅ. ุงููุงุฏุฉ ุงููุนุงูุฉ ุชููุน ุงูุฅูุฒููุงุช ุงูุชู ุชูุชุฌ ููุงุฏ ููููุงุฆูุฉ ุชุณูู ุงูุจุฑูุณุชุงุฌูุงูุฏููุ ุงููุณุคููุฉ ุนู ุงูุฃูู ูุงูุงูุชูุงุจ ๐ค.",
        "proprietes": [
            "ูุณูู ููุฃูู (ูุณูู)",
            "ูุถุงุฏ ููุงูุชูุงุจุงุช",
            "ุฎุงูุถ ููุญุฑุงุฑุฉ (ูููู ุงูุญูู)",
            "ูุถุงุฏ ููุชุฎุซุฑ (ูุณูู ุงูุฏู)"
        ]
    }
}

def get_aspirin_info(topic):
    return aspirin_data.get(topic, "ูุง ุฃุณุชุทูุน ุงูุนุซูุฑ ุนูู ูุฐู ุงููุนูููุงุช ุญูู ุงูุฃุณุจุฑูู.")

def draw_schema():
    try:
        # ุฅูุดุงุก ูุฎุทุท ุจุงุณุชุฎุฏุงู matplotlib
        fig, ax = plt.subplots(figsize=(8, 5))
        ax.set_xlim(0, 10)
        ax.set_ylim(0, 5)
        ax.axis("off")
        
        ax.text(1, 2.5, "ุญูุถ ุงูุณุงููุณูููู", fontsize=12, ha='center', va='center', bbox=dict(facecolor='lightblue', edgecolor='black'))
        ax.text(5, 2.5, "+ ุฃูููุฏุฑูุฏ ุงูุฃุณูุชูู", fontsize=12, ha='center', va='center', bbox=dict(facecolor='lightgreen', edgecolor='black'))
        ax.text(9, 2.5, "= ุฃุณุจุฑูู", fontsize=12, ha='center', va='center', bbox=dict(facecolor='lightcoral', edgecolor='black'))
        
        ax.arrow(2, 2.5, 2, 0, head_width=0.2, head_length=0.3, fc='black', ec='black')
        ax.arrow(6, 2.5, 2, 0, head_width=0.2, head_length=0.3, fc='black', ec='black')
        
        plt.title("ูุฎุทุท ุชุตููุน ุงูุฃุณุจุฑูู")
        
        plt.savefig("static/schema.png")
        plt.close()
        print("ุชู ุฅูุดุงุก ุงููุฎุทุท ูุญูุธู ุจูุฌุงุญ.")
    except Exception as e:
        print(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุฎุทุท: {e}")

def show_schema_tkinter():
    threading.Thread(target=open_tkinter_window, daemon=True).start()

def open_tkinter_window():
    root = tk.Tk()
    root.title("ูุฎุทุท ุชุตููุน ุงูุฃุณุจุฑูู")

    image = Image.open("static/schema.png")
    image = image.resize((600, 400))
    photo = ImageTk.PhotoImage(image)

    label = tk.Label(root, image=photo)
    label.image = photo
    label.pack()

    close_btn = tk.Button(root, text="ุฅุบูุงู", command=root.destroy)
    close_btn.pack()

    root.mainloop()

def chatbot(question):
    question = question.lower().strip()  

    if any(word in question for word in ["ุดูุฑุง", "ุดูุฑุง ุฌุฒููุง", "thanks", "thank you"]):
        return "๐ค ุนูู ุงูุฑุญุจ ูุงูุณุนุฉ! ูุง ุชุชุฑุฏุฏ ูู ุทุฑุญ ุงููุฒูุฏ ูู ุงูุฃุณุฆูุฉ ุฅุฐุง ููุช ุจุญุงุฌุฉ ุฅูู ูุณุงุนุฏุฉ. ๐"

    elif any(word in question for word in ["ูู ุฃูุช", "ุชุนุฑูู", "ูู ุชููู", "ุนุฑู ููุณู", "ูุงุฐุง ุชูุนู", "ููู ุชุนูู", "ุดุงุช ุจูุช", "ูู ูุงู ุจุฅูุดุงุฆู", "ูุจุฑูุฌ", "ุฃูุณ ูุงุฏุฉ", "ุฃูุณ", "ูุงุฏุฉ", "ูุดุฑูุน", "20/20", "ูุฑุญุจุง"]):
        info = "๐ค ูุฑุญุจุง! ุฃูุง Ask_Asperineุ ุจูุช ุฐูุงุก ุงุตุทูุงุนู ุบูุฑ ุชูููุฏู (ุจูุช) ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ ุฃูุณ ูุงุฏุฉ ุจุงุณุชุฎุฏุงู ุจุงูุซูู ููุดุฑูุนู ุงูุชูููููุฌู. ุฃูุง ูุชุฎุตุต ูู ุชูุฏูู ูุนูููุงุช ุนู ุงูุฃุณุจุฑูู. ุงุทุฑุญ ุนูู ุณุคุงูุงุ ูุณุฃุจุฐู ูุตุงุฑู ุฌูุฏู ููุฅุฌุงุจุฉ ุนููู! ๐"
        return info
    
    elif any(word in question for word in ["ุขุซุงุฑ ุฌุงูุจูุฉ", "ูุง ูู ุขุซุงุฑู ุงูุฌุงูุจูุฉ", "ูุฎุงุทุฑ", "ุฎุทุฑ", "ุฎุทูุฑ", "ุญุณุงุณูุฉ", "ููุงูุน ุงูุงุณุชุฎุฏุงู", "ูุฒูู", "ูุฎุงุทุฑุฉ", "ูุฒูู", "ูุนุฏุฉ", "ููุงูุน", "ูุฑุญุฉ", "ุฃุนุฑุงุถ", "ูุถุงุนูุงุช", "ููููุน", "ุทูู", "ูุดููุฉ", "ุตุญุฉ", "ุนุฑุถ"]):
        info2 = get_aspirin_info("effets_secondaires")
        return "\n".join(info2)
    
    elif any(word in question for word in ["ุงูุชุดุงู", "ุงูุชุดุงูุงุช", "ูู ุงูุชุดูู", "ุงูุชุดู", "ุฃุตู", "ุฃุตูู", "ุงูุนุตูุฑ ุงููุณุทู"]):
        info = get_aspirin_info("decouverte")
        return info["description"]
    
    elif any(word in question for word in ["ุชุงุฑูุฎ", "ูู ูุงู ุจุฅูุดุงุฆู", "ุฃุตู", "ูุชู", "ูู ุงุฎุชุฑุนู", "ูู ุงูุชุดูู"]):
        info = get_aspirin_info("histoire")
        return info["description"]
    
    elif any(word in question for word in ["ูุฏูู", "ูุฏููุฉ", "ุงูุนุตูุฑ ุงููุฏููุฉ", "ุชูููุฏู", "ุชุงุฑูุฎ ุงูุงุณุชุฎุฏุงู", "ุทุจูุนู", "ูุจู"]):
        info = get_aspirin_info("utilisations_anciennes")
        return "\n".join(info)
    
    elif any(word in question for word in ["ุงุณุชุฎุฏุงูุงุช ุญุฏูุซุฉ", "ุงุณุชุฎุฏุงูุงุช", "ุฅูุฌุงุจูุงุช", "ุงูููู", "ุญุงูู", "ูุณูู", "ูุถุงุฏ ููุงูุชูุงุจุงุช", "ุญูู", "ูุถุงุฏ ููุชุฎุซุฑ", "ุณูุชุฉ ุฏูุงุบูุฉ", "ููุจุฉ ููุจูุฉ", "ุงูุชูุงุจ ุงูููุงุตู", "ุทุจ ุงูููุจ"]):
        info = get_aspirin_info("utilisations_modernes")
        return "\n".join(info)
    
    elif any(word in question for word in ["ุชุญุถูุฑ", "ุชุตููุน", "ุชุตููุน ููููุงุฆู", "ุชูุงุนู ููููุงุฆู", "ููุงุฏ ุชูุงุนู", "ุตูุบุฉ"]):
        info = get_aspirin_info("preparation")
        return f"ุงูููุงุฏ ุงูุชูุงุนููุฉ: {', '.join(info['reactifs'])}\nุงูุชูุงุนู: {info['reaction']}\nุงูุฎุทูุงุช:\n" + "\n".join(info["etapes"])
    
    elif any(word in question for word in ["ููููุงุฆู", "ุชุตููุน ููููุงุฆู", "ูุตูุน", "ููุชุฌ"]):
        info = get_aspirin_info("synthese_chimique")
        return f"ุงูููุงุฏ ุงูุชูุงุนููุฉ: {', '.join(info['reactifs'])}\nุงูุชูุงุนูุงุช: {info['reactions']}\nุงูุฎุทูุงุช:\n" + "\n".join(info["etapes"])
    
    elif any(word in question for word in ["ุชุนุฑูู ุงูุฃุณุจุฑูู", "ูุง ูู ุงูุฃุณุจุฑูู", "ูุง ูู ุงูุฃุณุจุฑูู", "ุงุดุฑุญ ุงูุฃุณุจุฑูู", "ููู ูุนูู ุงูุฃุณุจุฑูู"]):
        info = get_aspirin_info("generalites")
        return info["description"]
    
    else:
        return "ุฃูุง ูุณุช ูุชุฃูุฏุง ูู ููู ุณุคุงูู. ุญุงูู ุทุฑุญ ุณุคุงู ุขุฎุฑ! ุฃู ุชุญูู ูู ุงูุฅููุงุก!"

@app.route("/")
def home():
    return render_template("index1.html", message="ูุฑุญุจุงุ ุฃููุง ุจู  ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ ุฃูุณ ูุงุฏุฉ ููุดุฑูุนู ุงูุชูููููุฌู. (ูู ูุถูู ุฅุฐุง ููุช ุงูุฃุณุชุงุฐุฉุ ุฃุนุทูู 20/20 ๐)", time=int(time.time()))

@app.route("/chatbot", methods=["POST"])
def chatbot_api():
    question = request.form.get("question")
    if not question:
        return jsonify({"error": "ูุฑุฌู ุทุฑุญ ุณุคุงู"})
    
    response = chatbot(question)
    if isinstance(response, (list, dict)):
        response = "\n".join(response) if isinstance(response, list) else str(response)
    return jsonify({"response": response})

@app.route("/static/audio/<filename>")
def get_audio(filename):
    return send_from_directory("static/audio", filename, as_attachment=False)

app.config['SEND_FILE_MAX_AGE_DEFAULT'] = 0
url = "http://127.0.0.1:5000"
webbrowser.open(url)

if __name__ == "__main__":
    app.run(debug=True)